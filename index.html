<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ë¬¸ ì˜í™” íë ˆì´ì…˜ ì„œë¹„ìŠ¤ ì„ íƒ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cinematic Fonts (Oswald for titles, Inter for body) -->
    <style>
        /* Oswald for powerful, condensed titles. Inter for clean body text. */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Oswald:wght<-700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #1a1a1a; /* Dark Theater Background */
            color: #f0f0f0; 
        }
        h1, h2 {
            font-family: 'Oswald', sans-serif; /* High-impact, condensed title font */
        }
        /* Custom Shadow for dramatic effect (like a stage light - now white/silver) */
        .cinematic-shadow { 
            /* White/Silver soft glow for monochrome drama */
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.05), 0 0 40px rgba(255, 255, 255, 0.1); 
        }
        .keyword-tag {
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border-width: 2px;
        }
        /* Selected keyword is glowing silver/white */
        .keyword-tag.selected {
            transform: scale(1.05);
            background-color: #d1d5db; /* Light Gray */
            color: #1a1a1a;
            border-color: #ffffff;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Main Container - Dark, high-contrast style -->
    <div id="app" class="max-w-5xl mx-auto bg-gray-900 cinematic-shadow rounded-xl p-6 md:p-12 border-t-4 border-gray-400">
        
        <!-- Header - Silver Title -->
        <header class="mb-10 text-center">
            <h1 class="text-5xl font-extrabold text-gray-200 mb-2 tracking-widest uppercase">ë‹¹ì‹ ì„ ìœ„í•œ ë§ì¶¤í˜• íë ˆì´í„°</h1>
            <p class="text-xl text-gray-400">ê°€ì¥ ì„ í˜¸í•˜ëŠ” ì˜í™” ì¶”ì²œ ë°©ì‹ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        </header>

        <!-- Service Selection View (Initial Screen) -->
        <div id="selectionView" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Card 1: Vibe/History Based Recommendation - ì „ì²´ ì¹´ë“œ í´ë¦­ ê°€ëŠ¥ -->
            <div id="selectVibe" class="cinematic-shadow p-8 rounded-xl border-4 border-gray-700 hover:border-gray-400 transition duration-300 cursor-pointer bg-gray-800/50" data-service="vibe">
                <div class="text-gray-400 mb-4">
                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v14L9 19z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18v-5l-3-3m3 3h3"></path></svg>
                </div>
                <h2 class="text-3xl font-bold text-center text-gray-300 mb-3 tracking-wider uppercase">1. ì‹œì²­ ê¸°ë¡ ê¸°ë°˜ (VIBE)</h2>
                <p class="text-gray-300 text-center">ì´ë¯¸ ë´¤ë˜ **ì¢‹ì•„í•˜ëŠ” ì˜í™” ì—¬ëŸ¬ ê°œ**ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ê·¸ ì˜í™”ë“¤ì˜ ê³µí†µëœ ë¶„ìœ„ê¸°ì™€ í‚¤ì›Œë“œì— ì™„ë²½íˆ ë§ëŠ” ìƒˆë¡œìš´ ì˜í™” 5í¸ì„ ì¶”ì²œë°›ìŠµë‹ˆë‹¤.</p>
                <button class="mt-5 w-full bg-white text-gray-900 py-3 rounded-lg font-bold text-lg hover:bg-gray-200 transition duration-300 shadow-xl border-b-4 border-gray-700">
                    ğŸ¬ ì´ ëª¨ë“œ ì„ íƒí•˜ê¸°
                </button>
            </div>

            <!-- Card 2: Keyword Narrowing Service - ì „ì²´ ì¹´ë“œ í´ë¦­ ê°€ëŠ¥ -->
            <div id="selectKeyword" class="cinematic-shadow p-8 rounded-xl border-4 border-gray-700 hover:border-gray-400 transition duration-300 cursor-pointer bg-gray-800/50" data-service="keyword">
                <div class="text-gray-400 mb-4">
                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <h2 class="text-3xl font-bold text-center text-gray-300 mb-3 tracking-wider uppercase">2. í‚¤ì›Œë“œ ê¸°ë°˜ (NARROW)</h2>
                <p class="text-gray-300 text-center">ë³´ê³  ì‹¶ì€ ì˜í™”ì˜ ì¡°ê±´ì„ **ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ëª©ë¡ì—ì„œ ì„ íƒ**í•˜ì—¬, ê·¸ ì¡°ê±´ì— ê°€ì¥ ì˜ ë§ëŠ” ì˜í™” ëª©ë¡ 5í¸ì„ AIê°€ ì œì‹œí•©ë‹ˆë‹¤.</p>
                <button class="mt-5 w-full bg-white text-gray-900 py-3 rounded-lg font-bold text-lg hover:bg-gray-200 transition duration-300 shadow-xl border-b-4 border-gray-700">
                    ğŸŒŸ ì´ ëª¨ë“œ ì„ íƒí•˜ê¸°
                </button>
            </div>
        </div>

        <!-- Mode Specific Views (Hidden by default) -->
        <div id="serviceView" class="hidden mt-10 border-t border-gray-700 pt-8">
            <button id="backToSelection" class="text-gray-400 hover:text-white mb-6 flex items-center transition duration-200 text-lg font-semibold">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                ë©”ì¸ ì„œë¹„ìŠ¤ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
            
            <h2 id="serviceTitle" class="text-4xl font-bold mb-8 text-center text-gray-200 uppercase"></h2>
            
            <!-- Loading Indicator -->
            <div id="loading" class="text-center py-12 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-gray-400 mx-auto mb-4"></div>
                <p class="text-gray-400 font-semibold text-xl" id="loadingText">ì˜í™” ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <!-- 1. Vibe/History Based Form - Silver Accent -->
            <div id="vibeForm" class="hidden max-w-2xl mx-auto space-y-6 p-6 bg-gray-700 rounded-lg border border-gray-600 cinematic-shadow">
                <p class="text-gray-300 font-medium text-lg">ìµœì†Œ 2ê°œ, ìµœëŒ€ 3ê°œì˜ ì˜í™” ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ì´ ì˜í™”ë“¤ì˜ ë¶„ìœ„ê¸°, ì¥ë¥´, ì£¼ì œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                <input type="text" id="vibeMovie1" placeholder="ì¢‹ì•„í•˜ëŠ” ì˜í™” 1 (ì˜ˆ: ê¸°ìƒì¶©)" class="w-full p-4 border border-gray-600 rounded-lg focus:ring-gray-400 focus:border-gray-400 bg-gray-800 text-white placeholder-gray-500">
                <input type="text" id="vibeMovie2" placeholder="ì¢‹ì•„í•˜ëŠ” ì˜í™” 2 (ì˜ˆ: ë¼ë¼ëœë“œ)" class="w-full p-4 border border-gray-600 rounded-lg focus:ring-gray-400 focus:border-gray-400 bg-gray-800 text-white placeholder-gray-500">
                <input type="text" id="vibeMovie3" placeholder="ì¢‹ì•„í•˜ëŠ” ì˜í™” 3 (ì„ íƒ ì‚¬í•­)" class="w-full p-4 border border-gray-600 rounded-lg focus:ring-gray-400 focus:border-gray-400 bg-gray-800 text-white placeholder-gray-500">
                
                <button id="getVibeRecommendationBtn" class="w-full bg-white text-gray-900 py-4 rounded-lg font-bold text-xl hover:bg-gray-200 transition duration-300 shadow-2xl border-b-4 border-gray-700">
                    <span id="vibeBtnText">ìœ ì‚¬í•œ ì˜í™” 5í¸ ì¶”ì²œë°›ê¸°</span>
                    <div id="vibeSpinner" class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900 ml-2 hidden"></div>
                </button>
            </div>

            <!-- 2. Keyword Sub-Selection View - White/Silver Accent -->
            <div id="keywordSubSelectionView" class="hidden max-w-3xl mx-auto space-y-8">
                <h3 class="text-3xl font-semibold text-center text-gray-200 border-b border-gray-700 pb-4 uppercase">í‚¤ì›Œë“œ ì…ë ¥ ë°©ì‹ ì„ íƒ</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Option 1: Direct Input -->
                    <div id="selectDirectInput" class="cinematic-shadow p-8 rounded-xl border-4 border-gray-700 hover:border-gray-400 transition duration-300 cursor-pointer bg-gray-800">
                        <h4 class="text-2xl font-bold text-gray-300 mb-3">A. í‚¤ì›Œë“œ ì§ì ‘ ì…ë ¥ (ììœ  ì„œìˆ )</h4>
                        <p class="text-gray-400">ì›í•˜ëŠ” ë¶„ìœ„ê¸°ë‚˜ ì¡°ê±´ì„ **ììœ ë¡­ê²Œ** ì„œìˆ í•©ë‹ˆë‹¤. (ì˜ˆ: 'í™ì½© ëŠì™€ë¥´, ìš°ìš¸í•¨, ë¹—ì†ì˜ ì•¡ì…˜')</p>
                        <button class="mt-5 w-full bg-white text-gray-900 py-3 rounded-lg font-semibold text-lg hover:bg-gray-200 shadow-xl border-b-4 border-gray-700">
                            ì§ì ‘ ì…ë ¥ ëª¨ë“œ ì‹œì‘
                        </button>
                    </div>
                    <!-- Option 2: Selection List -->
                    <div id="selectKeywordList" class="cinematic-shadow p-8 rounded-xl border-4 border-gray-700 hover:border-gray-400 transition duration-300 cursor-pointer bg-gray-800">
                        <h4 class="text-2xl font-bold text-gray-300 mb-3">B. ëª©ë¡ì—ì„œ í‚¤ì›Œë“œ ì„ íƒ (ì •êµí•¨)</h4>
                        <p class="text-gray-400">AIê°€ ì œê³µí•˜ëŠ” ë°©ëŒ€í•œ ë¦¬ìŠ¤íŠ¸ì—ì„œ **ì›í•˜ëŠ” í‚¤ì›Œë“œë§Œ ê³¨ë¼** ì„ íƒí•©ë‹ˆë‹¤.</p>
                        <button class="mt-5 w-full bg-white text-gray-900 py-3 rounded-lg font-semibold text-lg hover:bg-gray-200 shadow-xl border-b-4 border-gray-700">
                            ì„ íƒ ëª¨ë“œ ì‹œì‘
                        </button>
                    </div>
                </div>
            </div>


            <!-- 2A. Keyword Direct Input Form - White Accent -->
            <div id="keywordForm" class="hidden max-w-2xl mx-auto space-y-6 p-6 bg-gray-700 rounded-lg border border-gray-600 cinematic-shadow">
                <p class="text-gray-300 font-medium text-lg">ì›í•˜ëŠ” ì˜í™”ì˜ ë¶„ìœ„ê¸°, ì¥ë¥´, ì£¼ì œ, ê°ë… ë“± êµ¬ì²´ì ì¸ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                <textarea id="keywordInput" rows="4" class="w-full p-4 border border-gray-600 rounded-lg focus:ring-gray-400 focus:border-gray-400 bg-gray-800 text-white placeholder-gray-500" placeholder="ì˜ˆì‹œ: 'ê¸´ì¥ê° ë„˜ì¹˜ëŠ” ìŠ¤ë¦´ëŸ¬', 'ëª½í™˜ì ì¸ ì˜ìƒë¯¸ê°€ ê°€ë“í•œ ìœ ëŸ½ ì˜í™”', '90ë…„ëŒ€ í™ì½© ëˆ„ì•„ë¥´ ë¶„ìœ„ê¸°'"></textarea>
                
                <button id="getKeywordRecommendationBtn" class="w-full bg-white text-gray-900 py-4 rounded-lg font-bold text-xl hover:bg-gray-200 transition duration-300 shadow-2xl border-b-4 border-gray-700">
                    <span id="keywordBtnText">í‚¤ì›Œë“œì— ë§ëŠ” ì˜í™” 5í¸ ì¶”ì²œë°›ê¸°</span>
                    <div id="keywordSpinner" class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900 ml-2 hidden"></div>
                </button>
                <button id="backToKeywordSubSelectionFromDirect" class="text-gray-500 hover:text-gray-400 w-full text-center mt-4 text-sm transition">
                    ë‹¤ë¥¸ í‚¤ì›Œë“œ ì…ë ¥ ë°©ì‹ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>

            <!-- 2B. Keyword Selection List Form - White Accent -->
            <div id="selectionForm" class="hidden max-w-4xl mx-auto space-y-6 p-8 bg-gray-700 rounded-lg border border-gray-600 cinematic-shadow">
                <p class="text-gray-300 font-medium text-lg">ì›í•˜ëŠ” í‚¤ì›Œë“œë¥¼ **ìµœì†Œ 3ê°œ ì´ìƒ** ì„ íƒí•´ ì£¼ì„¸ìš”. (í´ë¦­í•˜ë©´ ì„ íƒë©ë‹ˆë‹¤)</p>
                
                <div id="keywordTagContainer" class="flex flex-wrap gap-3 p-4 bg-gray-800 rounded-lg border border-gray-700 min-h-[120px]">
                    <!-- Keywords will be rendered here by JS -->
                </div>
                
                <div class="text-center font-bold text-gray-400 text-xl" id="selectedKeywordCount">ì„ íƒëœ í‚¤ì›Œë“œ: 0ê°œ</div>

                <button id="getSelectedRecommendationBtn" class="w-full bg-white text-gray-900 py-4 rounded-lg font-bold text-xl hover:bg-gray-200 transition duration-300 shadow-2xl border-b-4 border-gray-700">
                    <span id="selectionBtnText">ì„ íƒëœ í‚¤ì›Œë“œ ê¸°ë°˜ ì˜í™” 5í¸ ì¶”ì²œë°›ê¸°</span>
                    <div id="selectionSpinner" class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900 ml-2 hidden"></div>
                </button>
                <button id="backToKeywordSubSelectionFromSelect" class="text-gray-500 hover:text-gray-400 w-full text-center mt-4 text-sm transition">
                    ë‹¤ë¥¸ í‚¤ì›Œë“œ ì…ë ¥ ë°©ì‹ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>


            <!-- Recommendation Output -->
            <div id="recommendationOutput" class="mt-12 p-8 bg-gray-800 rounded-lg border-l-8 border-gray-400 cinematic-shadow hidden">
                <h4 class="text-3xl font-bold text-gray-200 mb-4 border-b border-gray-700 pb-3">âœ¨ AI íë ˆì´í„°ì˜ ì¶”ì²œ ê²°ê³¼ âœ¨</h4>
                <div id="aiRecommendationContent" class="text-gray-300 leading-relaxed whitespace-pre-wrap text-lg"></div>
                <div id="aiSources" class="mt-6 pt-3 border-t border-gray-700 text-sm text-gray-500"></div>
            </div>
            
        </div>

    </div>

    <!-- Application Logic (Improved Error Handling for 403) -->
    <script type="module">
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        //
        // ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ì—¬ê¸°ì— API KEYë¥¼ ë„£ìœ¼ì…”ì•¼ í•©ë‹ˆë‹¤! (ë°œê¸‰ë°›ì€ í‚¤ë¥¼ " " ì•ˆì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”) ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡
        // ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨
        const API_KEY = "AIzaSyDsEmoqYmgJAn6r_Gtrc6rKUkqalvV5gEY"; // ğŸ‘ˆ ğŸ‘ˆ ğŸ‘ˆ ì´ ë¹ˆ ë¬¸ìì—´ ì•ˆì— í‚¤ë¥¼ ë„£ì–´ì£¼ì„¸ìš”!
        // ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†
        
        // --- DOM ELEMENTS ---
        const selectionView = document.getElementById('selectionView');
        const serviceView = document.getElementById('serviceView');
        const serviceTitle = document.getElementById('serviceTitle');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const recommendationOutput = document.getElementById('recommendationOutput');
        const aiRecommendationContent = document.getElementById('aiRecommendationContent');
        const aiSources = document.getElementById('aiSources');
        const backToSelection = document.getElementById('backToSelection');
        
        // Vibe/History Elements
        const selectVibe = document.getElementById('selectVibe'); // Card DIV
        const vibeForm = document.getElementById('vibeForm');
        const vibeMovie1 = document.getElementById('vibeMovie1');
        const vibeMovie2 = document.getElementById('vibeMovie2');
        const vibeMovie3 = document.getElementById('vibeMovie3');
        const getVibeRecommendationBtn = document.getElementById('getVibeRecommendationBtn');
        const vibeBtnText = document.getElementById('vibeBtnText');
        const vibeSpinner = document.getElementById('vibeSpinner');

        // Keyword Elements
        const selectKeyword = document.getElementById('selectKeyword'); // Card DIV
        const keywordSubSelectionView = document.getElementById('keywordSubSelectionView');
        const selectDirectInput = document.getElementById('selectDirectInput');
        const selectKeywordList = document.getElementById('selectKeywordList');
        
        // Keyword Direct Input Elements
        const keywordForm = document.getElementById('keywordForm');
        const keywordInput = document.getElementById('keywordInput');
        const getKeywordRecommendationBtn = document.getElementById('getKeywordRecommendationBtn');
        const keywordBtnText = document.getElementById('keywordBtnText');
        const keywordSpinner = document.getElementById('keywordSpinner');
        const backToKeywordSubSelectionFromDirect = document.getElementById('backToKeywordSubSelectionFromDirect');

        // Keyword Selection List Elements
        const selectionForm = document.getElementById('selectionForm');
        const keywordTagContainer = document.getElementById('keywordTagContainer');
        const selectedKeywordCount = document.getElementById('selectedKeywordCount');
        const getSelectedRecommendationBtn = document.getElementById('getSelectedRecommendationBtn');
        const selectionBtnText = document.getElementById('selectionBtnText');
        const selectionSpinner = document.getElementById('selectionSpinner');
        const backToKeywordSubSelectionFromSelect = document.getElementById('backToKeywordSubSelectionFromSelect');

        // State
        let selectedKeywords = new Set();

        // --- MOCK DATA (Not used for core functionality, kept for context) ---
        function fetchMovieMetadata(movieTitle) {
            const title = movieTitle.toLowerCase().trim();
            const mockData = {
                // ... (previous mock data)
            };
            return mockData[title] || null;
        }
        
        // --- UTILITY FUNCTIONS ---
        
        // Hides all service views and shows only the target view
        function showView(target) {
            [vibeForm, keywordSubSelectionView, keywordForm, selectionForm, loading, recommendationOutput].forEach(el => el.classList.add('hidden'));
            if (target) {
                target.classList.remove('hidden');
            }
        }

        function setLoading(isLoading, text = "ì˜í™” ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...") {
            if (isLoading) {
                selectionView.classList.add('hidden');
                serviceView.classList.remove('hidden');
                showView(loading);
                loadingText.textContent = text;
            } else {
                loading.classList.add('hidden');
            }
        }

        // --- KEYWORD DATA & RENDER ---
        const ALL_KEYWORDS = [
            "ì•¡ì…˜", "SF", "íŒíƒ€ì§€", "ë“œë¼ë§ˆ", "ë©œë¡œ/ë¡œë§¨ìŠ¤", "ì½”ë¯¸ë””", "ìŠ¤ë¦´ëŸ¬", "ë²”ì£„",
            "ëŠì™€ë¥´", "í˜¸ëŸ¬", "ë¯¸ìŠ¤í„°ë¦¬", "ì„œë¶€", "ë®¤ì§€ì»¬", "ì „ìŸ", "ë‹¤íë©˜í„°ë¦¬", "ì• ë‹ˆë©”ì´ì…˜",
            "ì‹œëŒ€ê·¹", "ë³µìˆ˜", "ì„±ì¥", "ë°˜ì „", "ìŒëª¨ë¡ ", "ë””ìŠ¤í† í”¼ì•„", "ì•„ë¦„ë‹¤ìš´ ì˜ìƒë¯¸",
            "ìŠ¬í”ˆ", "ì”í˜¹í•œ", "ê°€ìŠ´ ë”°ëœ»í•œ", "ì² í•™ì ì¸", "ìœ ì¾Œí•œ", "Bê¸‰ ê°ì„±", "í•œêµ­ ì˜í™”",
            "ë¯¸êµ­ ì˜í™”", "ìœ ëŸ½ ì˜í™”", "ì•„ì‹œì•„ ì˜í™”", "90ë…„ëŒ€", "2000ë…„ëŒ€", "ìµœì‹ ì‘", "ë…ë¦½ì˜í™”"
        ];

        function renderKeywords() {
            keywordTagContainer.innerHTML = '';
            ALL_KEYWORDS.forEach(keyword => {
                const tag = document.createElement('span');
                tag.textContent = keyword;
                tag.className = 'keyword-tag inline-block px-4 py-2 text-sm font-semibold rounded-full border-gray-500 text-gray-400 bg-gray-900 transition duration-150 ease-in-out';
                tag.dataset.keyword = keyword;
                
                if (selectedKeywords.has(keyword)) {
                    tag.classList.add('selected');
                }

                tag.addEventListener('click', () => toggleKeyword(keyword, tag));
                keywordTagContainer.appendChild(tag);
            });
            updateSelectedCount();
        }

        function toggleKeyword(keyword, tag) {
            if (selectedKeywords.has(keyword)) {
                selectedKeywords.delete(keyword);
                tag.classList.remove('selected');
                tag.classList.remove('bg-gray-200', 'text-gray-900', 'border-white', 'shadow-white-glow');
            } else if (selectedKeywords.size < 8) {
                selectedKeywords.add(keyword);
                tag.classList.add('selected');
            } else {
                // í‚¤ì›Œë“œ ì„ íƒ ì œí•œ (8ê°œ)ì„ ì´ˆê³¼í–ˆì„ ë•Œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            selectedKeywordCount.textContent = `ì„ íƒëœ í‚¤ì›Œë“œ: ${selectedKeywords.size}ê°œ`;
        }
        
        // --- API CALL LOGIC ---
        
        async function callGeminiApi(systemPrompt, userQuery) {
            // Error handling for missing API key
            if (!API_KEY) {
                aiRecommendationContent.innerHTML = '<p class="text-red-500 font-bold">ğŸš¨ API Key ì˜¤ë¥˜: jsbin.comê³¼ ê°™ì€ ì™¸ë¶€ í™˜ê²½ì—ì„œëŠ” ì½”ë“œ ìƒë‹¨ì— API_KEYë¥¼ ì§ì ‘ ë„£ì–´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤. (ì½”ë“œ 320ë²ˆëŒ€ ì¤„ ê·¼ì²˜)</p>';
                setLoading(false);
                recommendationOutput.classList.remove('hidden');
                return null;
            }

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Enable grounding
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // Enhanced Retry Logic (Exponential Backoff)
            const MAX_RETRIES = 3;
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         if (response.status === 403) {
                            throw new Error("403 Forbidden: API Key ê¶Œí•œ ë¬¸ì œ ë˜ëŠ” ì˜ëª»ëœ í‚¤ì…ë‹ˆë‹¤.");
                        }
                        const errorBody = await response.json();
                        throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨ (Status: ${response.status}, Detail: ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        const sources = getGroundingSources(candidate);
                        return { text, sources };
                    }
                    throw new Error("API ì‘ë‹µì—ì„œ ìœ íš¨í•œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    if (attempt === MAX_RETRIES - 1) {
                         // Last attempt failed
                         if (error.message.includes("403 Forbidden")) {
                            aiRecommendationContent.innerHTML = '<p class="text-red-500 font-bold">ğŸš¨ API Key ì˜¤ë¥˜: ì‚¬ìš© ê¶Œí•œì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ í‚¤ì…ë‹ˆë‹¤. í‚¤ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. (ì½”ë“œ 320ë²ˆëŒ€ ì¤„ ê·¼ì²˜)</p>';
                        } else {
                            aiRecommendationContent.innerHTML = `<p class="text-red-500 font-bold">ğŸš¨ ì¶”ì²œ ì‹¤íŒ¨: API í˜¸ì¶œì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${error.message}) ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>`;
                        }
                        setLoading(false);
                        recommendationOutput.classList.remove('hidden');
                        return null;
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }
        
        function getGroundingSources(candidate) {
            const sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title)
                    .forEach(source => sources.push(source));
            }
            return sources;
        }

        // --- HANDLERS ---
        
        // Main selection handler
        function handleServiceSelection(service) {
            selectionView.classList.add('hidden');
            serviceView.classList.remove('hidden');
            recommendationOutput.classList.add('hidden');
            
            if (service === 'vibe') {
                serviceTitle.textContent = "1. ì‹œì²­ ê¸°ë¡ ê¸°ë°˜ (VIBE) ëª¨ë“œ";
                showView(vibeForm);
            } else if (service === 'keyword') {
                serviceTitle.textContent = "2. í‚¤ì›Œë“œ ê¸°ë°˜ (NARROW) ëª¨ë“œ";
                showView(keywordSubSelectionView);
            }
        }
        
        // Vibe/History recommendation request
        getVibeRecommendationBtn.addEventListener('click', async () => {
            const movies = [vibeMovie1.value.trim(), vibeMovie2.value.trim(), vibeMovie3.value.trim()].filter(t => t);

            if (movies.length < 2) {
                // Custom alert message instead of window.alert()
                aiRecommendationContent.innerHTML = '<p class="text-yellow-400 font-bold">âš ï¸ ê²½ê³ : ìµœì†Œ 2ê°œì˜ ì˜í™” ì œëª©ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</p>';
                recommendationOutput.classList.remove('hidden');
                return;
            }

            setLoading(true, `[${movies.join(', ')}] ì˜í™”ë“¤ì˜ ë¶„ìœ„ê¸°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...`);
            recommendationOutput.classList.add('hidden');
            
            const movieString = movies.join(', ');

            const systemPrompt = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì˜í™” íë ˆì´í„°ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì•¼ í•˜ë©°, ì‚¬ìš©ìê°€ ì œê³µí•œ ì˜í™” ${movies.length}í¸ì„ ë¶„ì„í•˜ì—¬ ê·¸ë“¤ì˜ ê³µí†µëœ ë¶„ìœ„ê¸°(vibe), ì¥ë¥´, ì£¼ì œë¥¼ ì™„ë²½í•˜ê²Œ ë§Œì¡±ì‹œí‚¤ëŠ” ìƒˆë¡œìš´ ì˜í™” 5í¸ì„ ì¶”ì²œí•´ ì£¼ì„¸ìš”.
            1. ì¶”ì²œí•˜ëŠ” ì˜í™” 5í¸ì€ ì‚¬ìš©ìê°€ ì´ë¯¸ ì œê³µí•œ ì˜í™”ë“¤ê³¼ëŠ” ë‹¤ë¥¸ ì˜í™”ì—¬ì•¼ í•©ë‹ˆë‹¤.
            2. ê° ì˜í™”ì— ëŒ€í•´ ì œëª©, ì¥ë¥´, ê·¸ë¦¬ê³  ì™œ ì¶”ì²œí•˜ëŠ”ì§€(ì§§ì€ ì´ìœ )ë¥¼ ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
            3. ì‘ë‹µì€ ë¶„ì„ ê²°ê³¼(ì‚¬ìš©ìê°€ ì œê³µí•œ ì˜í™”ë“¤ì˜ ê³µí†µëœ ë¶„ìœ„ê¸°)ì™€ ì¶”ì²œ ëª©ë¡ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.`;
            
            const userQuery = `ë‚´ê°€ ì¢‹ì•„í•œ ì˜í™” ëª©ë¡: ${movieString}. ì´ ì˜í™”ë“¤ì˜ ê³µí†µì ì¸ ë¶„ìœ„ê¸°ì— ë§ëŠ” ìƒˆë¡œìš´ ì˜í™” 5í¸ì„ ì¶”ì²œí•´ ì£¼ì„¸ìš”.`;

            const result = await callGeminiApi(systemPrompt, userQuery);
            if (result) {
                displayRecommendation(result);
            }
        });

        // Keyword Direct Input recommendation request
        getKeywordRecommendationBtn.addEventListener('click', async () => {
            const keywords = keywordInput.value.trim();

            if (!keywords) {
                aiRecommendationContent.innerHTML = '<p class="text-yellow-400 font-bold">âš ï¸ ê²½ê³ : ì›í•˜ëŠ” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>';
                recommendationOutput.classList.remove('hidden');
                return;
            }
            
            setLoading(true, `[${keywords}] í‚¤ì›Œë“œì— ë§ëŠ” ì˜í™”ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...`);
            recommendationOutput.classList.add('hidden');

            const systemPrompt = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì˜í™” íë ˆì´í„°ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì•¼ í•˜ë©°, ì‚¬ìš©ìê°€ ì œê³µí•œ í‚¤ì›Œë“œì™€ ì¡°ê±´ì— ê°€ì¥ ì˜ ë§ëŠ” ì˜í™” 5í¸ì„ ì¶”ì²œí•´ ì£¼ì„¸ìš”.
            1. ê° ì˜í™”ì— ëŒ€í•´ ì œëª©, ì¥ë¥´, ê·¸ë¦¬ê³  í‚¤ì›Œë“œì— ì–´ë–»ê²Œ ë¶€í•©í•˜ëŠ”ì§€(ì§§ì€ ì´ìœ )ë¥¼ ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
            2. ì‘ë‹µì€ ì‚¬ìš©ìê°€ ì œì‹œí•œ í‚¤ì›Œë“œ ìš”ì•½ê³¼ ì¶”ì²œ ëª©ë¡ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.`;
            
            const userQuery = `ë‚´ê°€ ì›í•˜ëŠ” ì˜í™”ì˜ í‚¤ì›Œë“œ/ì¡°ê±´: ${keywords}. ì´ ì¡°ê±´ì— ê°€ì¥ ì˜ ë§ëŠ” ìƒˆë¡œìš´ ì˜í™” 5í¸ì„ ì¶”ì²œí•´ ì£¼ì„¸ìš”.`;

            const result = await callGeminiApi(systemPrompt, userQuery);
            if (result) {
                displayRecommendation(result);
            }
        });

        // Keyword Selection List recommendation request
        getSelectedRecommendationBtn.addEventListener('click', async () => {
            if (selectedKeywords.size < 3) {
                aiRecommendationContent.innerHTML = '<p class="text-yellow-400 font-bold">âš ï¸ ê²½ê³ : ìµœì†Œ 3ê°œ ì´ìƒì˜ í‚¤ì›Œë“œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.</p>';
                recommendationOutput.classList.remove('hidden');
                return;
            }

            const keywordsArray = Array.from(selectedKeywords);
            const keywordString = keywordsArray.join(', ');
            
            setLoading(true, `ì„ íƒëœ [${keywordString}] í‚¤ì›Œë“œë¥¼ ì¡°í•©í•˜ì—¬ ìµœì ì˜ ì˜í™”ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...`);
            recommendationOutput.classList.add('hidden');

            const systemPrompt = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì˜í™” íë ˆì´í„°ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì•¼ í•˜ë©°, ì‚¬ìš©ìê°€ ì œê³µí•œ ${selectedKeywords.size}ê°œì˜ í‚¤ì›Œë“œ ì¡°í•©ì— ê°€ì¥ ì˜ ë§ëŠ” ì˜í™” 5í¸ì„ ì¶”ì²œí•´ ì£¼ì„¸ìš”.
            1. ê° ì˜í™”ì— ëŒ€í•´ ì œëª©, ì¥ë¥´, ê·¸ë¦¬ê³  í‚¤ì›Œë“œì— ì–´ë–»ê²Œ ë¶€í•©í•˜ëŠ”ì§€(ì§§ì€ ì´ìœ )ë¥¼ ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
            2. ì‘ë‹µì€ ì„ íƒëœ í‚¤ì›Œë“œ ì¡°í•©ì˜ íŠ¹ì§• ìš”ì•½ê³¼ ì¶”ì²œ ëª©ë¡ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.`;
            
            const userQuery = `ë‚´ê°€ ì„ íƒí•œ í‚¤ì›Œë“œ ì¡°í•©: ${keywordString}. ì´ ì¡°í•©ì— ê°€ì¥ ì˜ ë§ëŠ” ìƒˆë¡œìš´ ì˜í™” 5í¸ì„ ì¶”ì²œí•´ ì£¼ì„¸ìš”.`;

            const result = await callGeminiApi(systemPrompt, userQuery);
            if (result) {
                displayRecommendation(result);
            }
        });
        
        function displayRecommendation(result) {
            setLoading(false);
            showView(recommendationOutput);
            
            aiRecommendationContent.innerHTML = formatMarkdown(result.text);

            aiSources.innerHTML = 'ì¶œì²˜: ';
            if (result.sources.length > 0) {
                const sourceLinks = result.sources.map((src, index) => 
                    `<a href="${src.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition underline">${src.title || `ì¶œì²˜ ${index + 1}`}</a>`
                ).join(' | ');
                aiSources.innerHTML += sourceLinks;
            } else {
                 aiSources.innerHTML += 'êµ¬ê¸€ ê²€ìƒ‰ ê²°ê³¼ë¥¼ í™œìš©í–ˆìŠµë‹ˆë‹¤.';
            }

            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        // Simple Markdown to HTML formatter for displaying output
        function formatMarkdown(text) {
            if (!text) return '';
            
            // Bold (**text**)
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Headings (##, ###) - only replace leading ones for list structure
            text = text.replace(/^### (.*$)/gim, '<h4 class="text-xl font-semibold mt-4 mb-2">$1</h4>');
            text = text.replace(/^## (.*$)/gim, '<h3 class="text-2xl font-bold mt-6 mb-3 border-b border-gray-600 pb-1">$1</h3>');
            
            // Lists (* item)
            // Fix: Changed invalid 'gg' flag to valid 'g' flag
            text = text.replace(/\n\* (.*)/g, '\n<li>$1</li>');
            // Fix: Changed potentially unsupported 's' flag to valid 'g' flag to avoid SyntaxError.
            text = text.replace(/(\n<li>.*<\/li>)/g, '<ul class="list-disc list-inside mb-4 pl-4">$1</ul>');
            
            // Ensure proper line breaks for remaining text
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        // --- INITIALIZATION AND EVENT LISTENERS ---
        
        // FIX: Event listeners are attached to the main Card DIVs now, and the internal 'pointer-events-none' class has been removed from HTML content for reliability.
        selectVibe.addEventListener('click', () => handleServiceSelection('vibe'));
        selectKeyword.addEventListener('click', () => handleServiceSelection('keyword'));
        
        // Sub-Selection Clicks
        selectDirectInput.addEventListener('click', () => {
            showView(keywordForm);
        });
        selectKeywordList.addEventListener('click', () => {
            showView(selectionForm);
        });
        
        // Back Buttons
        backToSelection.addEventListener('click', () => {
            serviceView.classList.add('hidden');
            selectionView.classList.remove('hidden');
            recommendationOutput.classList.add('hidden'); // Hide output when returning to start
            selectedKeywords.clear(); // Reset state
            // Reset forms
            vibeMovie1.value = vibeMovie2.value = vibeMovie3.value = '';
            keywordInput.value = '';
            renderKeywords(); // Re-render to clear selections
        });

        backToKeywordSubSelectionFromDirect.addEventListener('click', () => {
            showView(keywordSubSelectionView);
        });

        backToKeywordSubSelectionFromSelect.addEventListener('click', () => {
            showView(keywordSubSelectionView);
        });

        // Initialize keyword tags for the selection list and attach other listeners
        window.onload = () => {
            renderKeywords();
            // Check for missing key on load
            if (!API_KEY) {
                console.warn("API Key is missing. Please insert your key in the script block for external use.");
            }
        };
        
    </script>
</body>
</html>
